<meta name="theme-color" content="currentcolor">


 {#if loading}
<Loader height="100vh" width="100vw" position="fixed" bgcolor="rgba(255, 255, 255, 0.7)" /> {/if}

<Panel>
    <h1 >2011 Census Atlas Demo</h1>
    <!-- <h1 style='border-bottom: 1px solid rgb(100, 120, 140);'/> -->

    {#if indicators && selectItem}

    {#if selectData}

    <PanelSection bind:all={panels} key='chart'>
    <ColChart data={selectData.lsoa.data} dataIndex={selectData.lsoa.index} breaks={selectData.lsoa.breaks} avg={selectData.ew.data} selected={active.lsoa.hovered ? active.lsoa.hovered : active.lsoa.selected} parent={active.lad.hovered ? selectData.lad.index[active.lad.hovered].median.code
        : active.lad.highlighted ? selectData.lad.index[active.lad.highlighted].median.code : active.lad.selected ? selectData.lad.index[active.lad.selected].median.code : null} siblings={active.lad.selected ? lad_dta.get(active.lad.selected).children : null}
        key="perc" />

        </PanelSection>
    {/if}

    <PanelSection bind:all={panels} key='infobox'>
    <div id="infobox">
        {selectMeta.table.name}
        <small>({selectMeta.table.code})</small><br />
        <strong class="text-med">{selectItem.name}</strong>
        <div class="grid">
            {#if selectData}
            <div>
                <hr style="border-top-color: #871A5B" />
                <strong>England & Wales</strong><br />
                <strong class="text-lrg">{selectData.ew.data.perc.toFixed(1)}%</strong><br />
                <small>{selectData.ew.data.value.toLocaleString()}
							of
							{selectData.ew.data.count.toLocaleString()}
							{selectItem.unit.toLowerCase()}s</small>
            </div>
            {#if active.lad.hovered || active.lad.highlighted || active.lad.selected}
            <div>
                <hr style="border-top-color: #27A0CC" />
                <strong>{active.lad.hovered ? lad_dta.get(active.lad.hovered).name : active.lad.highlighted ? lad_dta.get(active.lad.highlighted).name : lad_dta.get(active.lad.selected).name}</strong><br />
                <strong class="text-lrg">
								{#if active.lad.selected}<img src="./icons/chevron-left.svg" class="next" on:click={() => getSib('lad', -1)}>{/if}
								{active.lad.hovered ? selectData.lad.index[active.lad.hovered].perc.toFixed(1) : active.lad.highlighted ? selectData.lad.index[active.lad.highlighted].perc.toFixed(1) : selectData.lad.index[active.lad.selected].perc.toFixed(1)}%
								{#if active.lad.selected}<img src="./icons/chevron-right.svg" class="next" on:click={() => getSib('lad', 1)}>{/if}
							</strong><br />
                <small>{active.lad.hovered ? selectData.lad.index[active.lad.hovered].value.toLocaleString() : active.lad.highlighted ? selectData.lad.index[active.lad.highlighted].value.toLocaleString() : selectData.lad.index[active.lad.selected].value.toLocaleString()}
								of
								{active.lad.hovered ? selectData.lad.index[active.lad.hovered].count.toLocaleString() : active.lad.highlighted ? selectData.lad.index[active.lad.highlighted].count.toLocaleString() : selectData.lad.index[active.lad.selected].count.toLocaleString()}
								{selectItem.unit.toLowerCase()}s</small>
            </div>
            {:else}
            <div /> {/if} {#if active.lsoa.hovered || active.lsoa.selected}
            <div>
                <hr style="border-top-color: #000000" />
                <strong>{active.lsoa.hovered ? lsoalookup[active.lsoa.hovered].name.slice(-4) : lsoalookup[active.lsoa.selected].name.slice(-4)}</strong><br />
                <strong class="text-lrg">
								{#if active.lsoa.selected}<img src="./icons/chevron-left.svg" class="next" on:click={() => getSib('lsoa', -1)}>{/if}
								{active.lsoa.hovered ? selectData.lsoa.index[active.lsoa.hovered].perc.toFixed(1) : selectData.lsoa.index[active.lsoa.selected].perc.toFixed(1)}%
								{#if active.lsoa.selected}<img src="./icons/chevron-right.svg" class="next" on:click={() => getSib('lsoa', 1)}>{/if}
							</strong><br />
                <small>{active.lsoa.hovered ? selectData.lsoa.index[active.lsoa.hovered].value.toLocaleString() : selectData.lsoa.index[active.lsoa.selected].value.toLocaleString()}
								of
								{active.lsoa.hovered ? selectData.lsoa.index[active.lsoa.hovered].count.toLocaleString() : selectData.lsoa.index[active.lsoa.selected].count.toLocaleString()}
								{selectItem.unit.toLowerCase()}s</small>
            </div>
            {:else}
            <div /> {/if} {/if}
        </div>
    </div>
    </PanelSection>




    {#if lad_dta}

    <PanelSection bind:all={panels} key='area' bind:selected={active.lad.name}>

<!-- wrapper html to shrink select -->
      <Select options={[...lad_dta.values()]} bind:name={active.lad.name} bind:selected={active.lad.selected} search={true} placeholder="Find a district..."  on:select={()=> active.lsoa.selected = null} >
        <Geolocate width='30px' bind:position={latlon}/>

        </Select>


    </PanelSection>
		{/if}



<PanelSection bind:all={panels} key='data'>

        <Group
			props={{ name: '2011 Census Tables', children: indicators, menu:0 }}
			bind:selected={selectItem}
			expanded />

</PanelSection>

	{/if}
</Panel>






{#if mapLocation}
<MapComponent bind:map style={mapstyle} minzoom={4} maxzoom={14} bind:zoom={mapZoom} location={mapLocation}>
	{#if selectData}
		<MapSource
			id="lsoa"
			type="vector"
			url={lsoabldg.url}
			layer={lsoabldg.layer}
			promoteId={lsoabldg.code}
			maxzoom={13}>
			<MapLayer
				id="lsoa"
				source="lsoa"
				sourceLayer={lsoabldg.layer}
				data={selectData}
				type="fill"
				paint={{
					'fill-color': ['case',
						['!=', ['feature-state', 'color'], null], ['feature-state', 'color'],
						'rgba(255, 255, 255, 0)'
					]
				}}
				order="tunnel_motorway_casing" />
		</MapSource>
		<MapSource
			id="lsoa-bounds"
			type="vector"
			url={lsoabounds.url}
			layer={lsoabounds.layer}
			promoteId={lsoabounds.code}
			minzoom={9}
			maxzoom={12}>
			<MapLayer
				id="lsoa-fill"
				source="lsoa-bounds"
				sourceLayer={lsoabounds.layer}
				type="fill"
				paint={{ 'fill-color': 'rgba(255, 255, 255, 0)' }}
				hover={true}
				bind:hovered={active.lsoa.hovered}
				click={true}
				clickCenter={true}
				bind:selected={active.lsoa.selected} />
			<MapLayer
				id="lsoa-bounds"
				source="lsoa-bounds"
				sourceLayer={lsoabounds.layer}
				type="line"
				paint={{
					'line-color': ['case',
						['==', ['feature-state', 'selected'], true], 'rgba(0, 0, 0, 1)',
						['==', ['feature-state', 'hovered'], true], 'rgba(0, 0, 0, 1)',
						'rgba(0, 0, 0, 0)'
					],
					'line-width': ['case',
						['==', ['feature-state', 'selected'], true], 2,
						['==', ['feature-state', 'hovered'], true], 2,
						0
					]
				}} />
		</MapSource>
	{/if}
	{#if lad_dta}
		<MapSource
			id="lad"
			type="vector"
			url={ladvector.url}
			layer={ladvector.layer}
			promoteId={ladvector.code}>
			<MapLayer
				id="lad"
				source="lad"
				sourceLayer={ladvector.layer}
				type="line"
				highlight={true}
				highlighted={active.lad.highlighted}
				filter={[
					"all",
					["==", "lower", "true"],
					["in", "country", "E", "W"]
				]}
				paint={{
					'line-color': ['case',
						['==', ['feature-state', 'selected'], true], '#27A0CC',
						['==', ['feature-state', 'hovered'], true], '#27A0CC',
						['==', ['feature-state', 'highlighted'], true], '#27A0CC',
						'rgba(192, 192, 192, 1)'
					],
					'line-width': ['case',
						['==', ['feature-state', 'selected'], true], 2,
						['==', ['feature-state', 'hovered'], true], 2,
						['==', ['feature-state', 'highlighted'], true], 2,
						0.75
					]
				}}
				order="place_other" />
			<MapLayer
				id="lad-fill"
				source="lad"
				sourceLayer={ladvector.layer}
				type="fill"
				filter={[
					"all",
					["==", "lower", "true"],
					["in", "country", "E", "W"]
				]}
				paint={{ 'fill-color': 'rgba(255, 255, 255, 0)' }}
				hover={true}
				bind:hovered={active.lad.hovered}
				click={true}
				bind:selected={active.lad.selected}
				maxzoom={8.99}
				on:select={() => active.lsoa.selected = null} />
		</MapSource>
	{/if}
</MapComponent>
{/if}
